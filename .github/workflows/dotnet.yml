name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 7.0.x

    - name: Restore dependencies
      run: dotnet restore Trekster_web/Trekster_web.sln

    - name: Build solution
      run: dotnet build Trekster_web/Trekster_web.sln --no-restore

    - name: Run unit/integration tests (excluding UI)
      run: dotnet test Trekster_web/Trekster_web.sln --no-build --verbosity normal --filter "FullyQualifiedName!~TreksterUISeleniumTests"

    - name: Publish Trekster app
      run: dotnet publish Trekster_web/Trekster_web/Trekster_web.csproj -c Release -o ./publish

    - name: Run Trekster app in background
      run: |
        dotnet ./publish/Trekster_web.dll --urls "http://localhost:7034" > output.log 2>&1 &
        sleep 5
        cat output.log

    - name: Wait until app is ready
      run: |
        sudo apt-get install -y curl
        for i in {1..20}; do curl http://localhost:7034 && break || sleep 2; done

    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Restore and run Selenium UI Tests
      run: |
        dotnet restore Testing/TreksterUISeleniumTests/TreksterUISeleniumTests/TreksterUISeleniumTests.csproj
        dotnet test Testing/TreksterUISeleniumTests/TreksterUISeleniumTests/TreksterUISeleniumTests.csproj --verbosity normal
